rules_version = '2';

// WillMusic Sky Memo - Firestore Security Rules
// 架構：前端直接連 Firestore，無後端 API
// Collections: queue_pending, queue_history, tokens
//
// 部署：firebase deploy --only firestore:rules
// （需先 firebase init 並設定 firebase.json）

service cloud.firestore {
  match /databases/{database}/documents {

    // ========== 輔助函式 ==========

    // 驗證 StickyNoteStyle map
    function isValidStyle(style) {
      return style is map
        && style.keys().hasAll(['backgroundImage', 'shape', 'textColor'])
        && style.backgroundImage is string
        && style.shape is string
        && style.textColor is string
        && style.backgroundImage.size() <= 2048
        && style.shape.size() <= 64
        && style.textColor.size() <= 20;
    }

    // ========== tokens ==========
    // - 建立：Admin / createToken
    // - 讀取：Mobile（驗證）、Display（transaction 內讀取）
    // - 更新：createNote 時更新 status → used
    match /tokens/{tokenId} {
      allow read: if true;

      allow create: if request.auth == null
        && request.resource.data.keys().hasAll(['status', 'createdAt'])
        && request.resource.data.status in ['unused', 'used']
        && request.resource.data.size() == 2;

      allow update: if request.auth == null
        && request.resource.data.keys().hasAll(['status', 'createdAt'])
        && request.resource.data.status in ['unused', 'used'];

      allow delete: if request.auth == null;
    }

    // ========== queue_pending ==========
    // - 建立：Mobile 提交（createNote）
    // - 讀取：Display 監聽
    // - 刪除：Display（moveToHistory）、Admin 清空
    match /queue_pending/{docId} {
      allow read: if true;

      allow create: if request.auth == null
        && request.resource.data.keys().hasAll(['content', 'style', 'token', 'timestamp', 'status'])
        && request.resource.data.content is string
        && request.resource.data.content.size() <= 1000
        && isValidStyle(request.resource.data.style)
        && request.resource.data.token is string
        && request.resource.data.token.size() <= 128
        && request.resource.data.status == 'waiting';

      allow update: if false; // 不允許更新，建立後僅可刪除

      allow delete: if request.auth == null;
    }

    // ========== queue_history ==========
    // - 建立：Display（moveToHistory）
    // - 讀取：Display、Mobile archive
    // - 刪除：Display（orphan cleanup）、Admin 清空
    match /queue_history/{docId} {
      allow read: if true;

      allow create: if request.auth == null
        && request.resource.data.keys().hasAll(['content', 'style', 'token', 'timestamp', 'status', 'playedAt'])
        && request.resource.data.content is string
        && request.resource.data.content.size() <= 1000
        && isValidStyle(request.resource.data.style)
        && request.resource.data.token is string
        && request.resource.data.token.size() <= 128
        && request.resource.data.status == 'played';

      allow update: if false;

      allow delete: if request.auth == null;
    }
  }
}
